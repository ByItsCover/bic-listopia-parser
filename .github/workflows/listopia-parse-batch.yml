name: listopia-parse-batch

on:
  workflow_dispatch:
    inputs:
      jobName:
        description: 'Job Name'
        required: true
        type: string
      queue:
        description: 'Batch Queue Name'
        required: true
        default: 'queue'
        type: choice
        options:
        - queue
      jobDefinition:
        description: 'Batch Job Definition'
        required: true
        default: 'listopia_parser_batch_job_definition'
        type: choice
        options:
        - listopia_parser_batch_job_definition
      listopiaUrl:
        description: 'Listopia URL For Scraping'
        required: true
        default: 'https://www.goodreads.com/list/show/4581.Judge_A_Book_By_Its_Cover_'
        type: string
      pageCount:
        description: 'Number of Listopia Pages to Scrape'
        required: true
        default: 10
        type: number

permissions:
  id-token: write
  contents: read

jobs:
  submit-batch:
    name: Submit Batch Job
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials for github actions
        uses: aws-actions/configure-aws-credentials@v4.0.2
        with:
          audience: sts.amazonaws.com
          aws-region: ${{ secrets.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_GITHUB_ROLE }}

      - name: Submit Job
        run: |
          aws batch submit-job \
              --job-name ${{ inputs.jobName }}-${{ github.run_id }} \
              --job-queue ${{ inputs.queue }} \
              --job-definition ${{ inputs.jobDefinition }} \
              --container-overrides '{
                "environment": [
                  {
                    "name": "ListopiaOptions__ListopiaUrl",
                    "value": "${{ inputs.listopiaUrl }}"
                  },
                  {
                    "name": "ListopiaOptions__Pages",
                    "value": "${{ inputs.pageCount }}"
                  }
                ]
              }'
